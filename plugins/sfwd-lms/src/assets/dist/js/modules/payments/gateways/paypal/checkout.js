learndash.paypal_checkout=learndash.paypal_checkout||{},((e,t,a,r,n)=>{const d=t.querySelector(".ld-paypal-checkout-sdk");let s=!0;n.init=()=>{if(d&&void 0!==a&&(n.showSavedCards(),n.setupButton(),n.setupCardFields(),n.handleSubscriptionProduct(),d.hasAttribute("data-client-token-expires-in"))){const t=parseInt(d.getAttribute("data-client-token-expires-in"),10)-Math.floor(Date.now()/1e3);t>0&&!e.ldPaypalTimeoutSet&&(e.ldPaypalTimeoutSet=!0,setTimeout((()=>{e.location.replace(e.location.href)}),1e3*t))}},n.showNotice=t=>{e.alert(t)},n.getSavePaymentMethodValue=e=>{if(!e)return!1;if(n.is_subscription_product)return!0;const a=t.querySelector("#ld-paypal-checkout__save-payment-method");return!!a&&a.checked},n.createOrder=(e,t)=>fetch(n.endpoints.create_order,{method:"POST",headers:{"Content-Type":"application/json","X-WP-Nonce":n.nonce,"Learndash-Experimental-Rest-Api":"Allow"},body:JSON.stringify({products:n.products,user_id:n.user_id,is_sandbox:n.is_sandbox,use_card_fields:e,save_payment_method:n.getSavePaymentMethodValue(e),customer_id:n.customer_id,vault_id:t})}).then((e=>e.json())).then((e=>e.success?e.data.order.id:(s=!1,n.showNotice(e.message),""))),n.handleApproveFail=e=>{"UNPROCESSABLE_ENTITY"===e.data[0].name&&"INSTRUMENT_DECLINED"===e.data[0].details[0].issue?n.showNotice(e.data[0].details[0].description):n.showNotice(e.data[0].message)},n.handleConfirmOrder=t=>fetch(n.endpoints.confirm_order,{method:"POST",headers:{"Content-Type":"application/json","X-WP-Nonce":n.nonce,"Learndash-Experimental-Rest-Api":"Allow"},body:JSON.stringify({order_id:t.orderID,user_id:n.user_id,is_sandbox:n.is_sandbox})}).then((e=>e.json())).then((t=>{t.success?e.location.href=t.data.redirect_url:n.handleGenericError(t.message)})),n.handleOrderApprove=e=>fetch(n.endpoints.capture_order,{method:"POST",headers:{"Content-Type":"application/json","X-WP-Nonce":n.nonce,"Learndash-Experimental-Rest-Api":"Allow"},body:JSON.stringify({order_id:e.orderID,payer_id:e.payerID,is_sandbox:n.is_sandbox})}).then((e=>e.json())).then((t=>{if(!t.success)return"UNPROCESSABLE_ENTITY"===t.data.name&&"ORDER_ALREADY_CAPTURED"===t.data.details[0].issue?void n.handleConfirmOrder(e):void n.handleApproveFail(t);n.handleConfirmOrder(e)})),n.handleOrderCancel=e=>fetch(n.endpoints.cancel_order,{method:"POST",headers:{"Content-Type":"application/json","X-WP-Nonce":n.nonce,"Learndash-Experimental-Rest-Api":"Allow"},body:JSON.stringify({order_id:e.orderID,user_id:n.user_id,is_sandbox:n.is_sandbox})}).then((e=>e.json())).then((e=>e.success?e.data.canceled:(n.showNotice(e.message),!1))),n.handleGenericError=e=>{if(!s)return void(s=!0);const a=t.querySelector("#btn-join--card");a&&(a.textContent=r.__("Checkout","learndash"),a.removeAttribute("disabled")),n.showNotice(e)},n.createSetupToken=e=>fetch(n.endpoints.setup_token,{method:"POST",headers:{"Content-Type":"application/json","X-WP-Nonce":n.nonce,"Learndash-Experimental-Rest-Api":"Allow"},body:JSON.stringify({product_id:n.products[0],user_id:n.user_id,is_sandbox:n.is_sandbox,use_card_fields:e})}).then((e=>e.json())).then((e=>e.success?e.data.setup_token.id:(s=!1,n.showNotice(e.message),""))),n.createPaymentToken=t=>fetch(n.endpoints.payment_token,{method:"POST",headers:{"Content-Type":"application/json","X-WP-Nonce":n.nonce,"Learndash-Experimental-Rest-Api":"Allow"},body:JSON.stringify({token_id:t.vaultSetupToken,user_id:n.user_id,product_id:n.products[0],is_sandbox:n.is_sandbox})}).then((e=>e.json())).then((t=>{t.success?e.location.href=t.data.success_url:n.showNotice(t.message)})),n.setupButton=()=>{const r=t.querySelector("#btn-join--paypal");if(!r)return;const d={style:{layout:"vertical",shape:"rect",label:"paypal"},onError:e=>n.handleGenericError(e)};n.requires_vault_setup_token?(d.displayOnly=["vaultable"],d.createVaultSetupToken=async t=>{if(null===t.paymentSource)return n.createSetupToken(!1);const a=await n.startTrial(!1,"paypal");return a&&(e.location.href=a),s=!1,""},d.onApprove=e=>n.createPaymentToken(e)):(d.createOrder=()=>n.createOrder(!1,""),d.onApprove=e=>n.handleOrderApprove(e),d.onCancel=e=>n.handleOrderCancel(e)),a.Buttons(d).render(r)},n.showCardFieldsNotice=e=>{"p is not a function"===e&&(e="unknown_error");const t={unknown_error:r.__("An invalid card was provided. Please review the card details and try again.","learndash"),ineligible_card_vendor:r.__("The card vendor is not supported.","learndash"),invalid_name:r.__("Please enter a valid card holder name.","learndash"),invalid_number:r.__("Please enter a valid card number.","learndash"),invalid_expiry:r.__("Please enter a valid card expiry date.","learndash"),invalid_cvv:r.__("Please enter a valid card security code.","learndash")},a=e.toLowerCase(),d=t[a];return d?n.showNotice(d):n.showNotice(a)},n.validateBillingAddress=()=>{if(!t.querySelector("#ld-paypal-checkout__billing-address-1").value)return n.showNotice(r.__("Please enter a valid billing address.","learndash")),!1;if(!t.querySelector("#ld-paypal-checkout__billing-postal").value)return n.showNotice(r.__("Please enter a valid postal/zip code.","learndash")),!1;const e=t.querySelector("#ld-paypal-checkout__billing-country");return!(!e.value||""===e.value)||(n.showNotice(r.__("Please select a country.","learndash")),!1)},n.setupCardFields=()=>{const e=t.querySelector("#btn-join--card");if(!e)return;const d={style:{input:{border:"1px solid #bfbfbf","border-radius":"0","font-size":"0.875rem",padding:"10px"},":focus":{"box-shadow":"none",outline:"1px solid #1d1d1d"}},onError:e=>n.handleGenericError(e)};n.requires_vault_setup_token?(d.createVaultSetupToken=()=>n.createSetupToken(!0),d.onApprove=e=>n.createPaymentToken(e)):(d.createOrder=()=>n.createOrder(!0,""),d.onApprove=e=>n.handleOrderApprove(e));const s=a.CardFields(d);if(!s.isEligible())return;const o=s.NameField(),i=s.NumberField(),l=s.ExpiryField(),c=s.CVVField();o.render("#ld-paypal-checkout__card-name-field"),i.render("#ld-paypal-checkout__card-number-field"),l.render("#ld-paypal-checkout__card-expiry-field"),c.render("#ld-paypal-checkout__card-cvv-field"),e.addEventListener("click",(a=>{if(a.preventDefault(),e.classList.contains("saved-card"))n.chargeCard();else{if(e.textContent=r.__("Processing payment…","learndash"),e.setAttribute("disabled","disabled"),!n.validateBillingAddress())return e.textContent=r.__("Checkout","learndash"),void e.removeAttribute("disabled");s.submit({billingAddress:{addressLine1:t.querySelector("#ld-paypal-checkout__billing-address-1").value,addressLine2:t.querySelector("#ld-paypal-checkout__billing-address-2").value,adminArea1:t.querySelector("#ld-paypal-checkout__billing-city").value,countryCode:t.querySelector("#ld-paypal-checkout__billing-country").value.toUpperCase(),postalCode:t.querySelector("#ld-paypal-checkout__billing-postal").value}}).then((()=>{e.textContent=r.__("Redirecting…","learndash")})).catch((t=>{e.textContent=r.__("Checkout","learndash"),e.removeAttribute("disabled"),n.showCardFieldsNotice(t.message)}))}}))},n.handleSavedCardSelection=e=>{const a=t.querySelector(".ld-paypal-checkout__card-info"),r=t.querySelector(".ld-paypal-checkout__billing-address"),n=t.querySelector(".ld-paypal-checkout__payment-options .ld-paypal-checkout__billing-field-wrapper"),d=t.querySelector("#btn-join--card");"new_card"===e?(a.style.display="block",r.style.display="block",n.style.display="block",d.classList.remove("saved-card")):e&&(a.style.display="none",r.style.display="none",n.style.display="none",d.classList.add("saved-card"))},n.showSavedCards=()=>{const e=t.querySelector(".ld-paypal-checkout__saved-cards");e&&n.customer_id&&(e.innerHTML="",fetch(`${n.endpoints.cards}?user_id=${n.user_id}&customer_id=${n.customer_id}&is_sandbox=${n.is_sandbox}`,{method:"GET",headers:{"Content-Type":"application/json","X-WP-Nonce":n.nonce,"Learndash-Experimental-Rest-Api":"Allow"}}).then((e=>e.json())).then((a=>{if(a.success&&a.data.cards.length>0){let d=`\n\t\t\t\t\t\t<label for="ld-paypal-checkout-saved-card" class="ld-paypal-checkout__billing-field-label">${r.__("Saved Cards","learndash")}</label>\n\t\t\t\t\t\t<select id="ld-paypal-checkout-saved-card" name="payment_method">\n\t\t\t\t\t`;a.data.cards.forEach((e=>{const t=r.sprintf(
// translators: %1$s: cardholder name, %2$s: card brand, %3$s: last digits, %4$s: expiry date.
r.__("%1$s's %2$s ***%3$s (%4$s)","learndash"),e.name||r.__("Card","learndash"),e.brand,e.last_digits,e.expiry);d+=`<option value="${e.token_id}">${t}</option>`})),d+=`<option value="new_card">${r.__("Add new card","learndash")}</option>`,d+="</select>",e.innerHTML=d,t.querySelector(".ld-paypal-checkout__saved-cards select").addEventListener("change",(e=>{n.handleSavedCardSelection(e.target.value)})),n.handleSavedCardSelection("existing_card")}})).catch((()=>{})))},n.startTrial=(e,t)=>fetch(n.endpoints.start_trial,{method:"POST",headers:{"Content-Type":"application/json","X-WP-Nonce":n.nonce,"Learndash-Experimental-Rest-Api":"Allow"},body:JSON.stringify({user_id:n.user_id,product_id:n.products[0],token_id:t,customer_id:n.customer_id,type:e?"card":"paypal",is_sandbox:n.is_sandbox})}).then((e=>e.json())).then((e=>e.success?e.data.success_url:(s=!1,n.showNotice(e.message),""))),n.chargeCard=async()=>{const a=t.querySelector("#ld-paypal-checkout-saved-card"),d=t.querySelector("#btn-join--card");if(!a||!d)return;const s=a.value;if(s){d.textContent=r.__("Processing payment…","learndash"),d.setAttribute("disabled","disabled");try{if(n.requires_vault_setup_token){d.textContent=r.__("Redirecting…","learndash"),d.setAttribute("disabled","disabled");const t=await n.startTrial(!0,s);if(t)return void(e.location.href=t);d.textContent=r.__("Checkout","learndash"),d.removeAttribute("disabled")}else{const e=await n.createOrder(!0,s);if(!e)return d.textContent=r.__("Checkout","learndash"),void d.removeAttribute("disabled");d.textContent=r.__("Redirecting…","learndash"),d.setAttribute("disabled","disabled"),await n.handleOrderApprove({orderID:e,payerID:""})}}catch(e){n.showNotice(e.message||r.__("An error occurred while processing the payment.","learndash")),d.textContent=r.__("Checkout","learndash"),d.removeAttribute("disabled")}}},n.handleSubscriptionProduct=()=>{if(!n.is_subscription_product)return;const e=t.querySelector("#ld-paypal-checkout__save-payment-method");if(!e)return;e.checked=!0,e.style.display="none",e.parentElement.style.display="none";const a=t.createElement("span");a.classList.add("ld-paypal-checkout__billing-field-label"),a.innerHTML=r.__("Your payment method will be saved and used for future payments.","learndash"),e.parentElement.parentElement.appendChild(a)},n.init()})(window,document,window.paypal,window.wp.i18n,learndash.paypal_checkout);